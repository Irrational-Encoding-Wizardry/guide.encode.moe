<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scenefiltering</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../CONTRIBUTING.html">Contributing to the Guide</a></li><li class="chapter-item expanded affix "><li class="part-title">General Fansubbing</li><li class="chapter-item expanded "><a href="../overview/preface.html"><strong aria-hidden="true">1.</strong> Preface</a></li><li class="chapter-item expanded "><a href="../overview/roles.html"><strong aria-hidden="true">2.</strong> Roles</a></li><li class="chapter-item expanded "><a href="../overview/requirements.html"><strong aria-hidden="true">3.</strong> Requirements</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Collaboration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../subtitling/collaboration/ftp.html"><strong aria-hidden="true">4.1.</strong> With FTP</a></li><li class="chapter-item expanded "><a href="../subtitling/collaboration/github.html"><strong aria-hidden="true">4.2.</strong> With git (via GitHub)</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Encoding</li><li class="chapter-item expanded "><a href="../encoding/preparation.html"><strong aria-hidden="true">5.</strong> Preparations and Necessary Software</a></li><li class="chapter-item expanded "><a href="../encoding/basics-and-workflow.html"><strong aria-hidden="true">6.</strong> Basics and General Workflow</a></li><li class="chapter-item expanded "><a href="../encoding/video-artifacts.html"><strong aria-hidden="true">7.</strong> Recognizing Video Artifacts</a></li><li class="chapter-item expanded "><a href="../encoding/scenefiltering.html" class="active"><strong aria-hidden="true">8.</strong> Scenefiltering</a></li><li class="chapter-item expanded "><a href="../encoding/masking-limiting-etc.html"><strong aria-hidden="true">9.</strong> Masking, Limiting, and Related Functions</a></li><li class="chapter-item expanded "><a href="../encoding/descaling.html"><strong aria-hidden="true">10.</strong> Descaling</a></li><li class="chapter-item expanded "><a href="../encoding/resampling.html"><strong aria-hidden="true">11.</strong> Resampling</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Codecs</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../encoding/codecs/x264.html"><strong aria-hidden="true">12.1.</strong> x264</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Typesetting</li><li class="chapter-item expanded "><a href="../typesetting/aegisub.html"><strong aria-hidden="true">13.</strong> Aegisub and Other Tools</a></li><li class="chapter-item expanded "><a href="../typesetting/masking/index.html"><strong aria-hidden="true">14.</strong> Masking With PS &amp; AI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../typesetting/masking/image-processing.html"><strong aria-hidden="true">14.1.</strong> Image Processing in PS</a></li><li class="chapter-item expanded "><a href="../typesetting/masking/image-tracing.html"><strong aria-hidden="true">14.2.</strong> Image Tracing in AI</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Resources and References</li><li class="chapter-item expanded "><a href="../archived-websites/bt601-vs-bt709.html"><strong aria-hidden="true">15.</strong> Colorspaces</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../impressum.html">Impressum</a></li><li class="chapter-item expanded affix "><a href="../privacy-policy.html">Privacy Policy</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/Irrational-Encoding-Wizardry/guide.encode.moe" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#scenefiltering" id="scenefiltering">Scenefiltering</a></h1>
<p>Scenefiltering can be hazardous to both your mind and body if used
extensively. Avoid scenefiltering if possible.</p>
<p>If you’re an aspiring young encoder or someone who has been around
fansubbing for a while, you’ve probably heard the term “scenefiltering”.
But what is scenefiltering? As the name suggests, it is simply filtering
different scenes or frames of a video clip distinctly.</p>
<h2><a class="header" href="#creating-the-base-filters" id="creating-the-base-filters">Creating the base filters</a></h2>
<p>Normally, if you have a source that has great video quality with minimal
video artifacts, you can use a simple chain of filters on the entire
video without any concern. However, if you have a more complex source
with a myriad of video artefacts, you probably don’t want to use the
same filters everywhere. For instance, one scene could have heavy
banding while another scene might have strong aliasing. If you were to
fix both of these issues by using strong filtering over the entire
video, it would likely result in detail loss in other scenes, which you
do not want. This is where scenefiltering comes in.</p>
<p>As always, you start by importing the VapourSynth module and loading
your video source:</p>
<pre><code class="language-py">import vapoursynth as vs  # this can look different based on your editor
core = vs.core

src = core.lsmas.LWLibavSource(&quot;source.m2ts&quot;)
</code></pre>
<p>Next, you need to choose what filtering will be done to the entire clip.
Some filtering—like resizing in this example—may
need to be put before any other filtering.
At this stage,
you can also come up with the default filters
that need to be in a certain order,
but will still be applied to the entire clip.
If you can’t come up with anything suitable, don’t fret;
you’ll have plenty more chances to filter later.</p>
<pre><code class="language-py">filtered = core.resize.Bilinear(src, width=1280, height=720)

# will occur at the deband stage, but for entire clip
default_deband = deband(filtered)
</code></pre>
<p>Now that you have your common filtering down, you need to create some
base filter chains. Go through some random scenes in your source and
write down parts of the filtering that best suits those scenes. You
should separate these as variables with proper names and sorting (group
filters by their type) to keep everything neat and clean. If you do this
part well, you will save yourself a lot of time later on, so take your
time. At this point, your script should look something like this:</p>
<pre><code class="language-py">import vapoursynth as vs
core = vs.core

src = core.lsmas.LWLibavSource(&quot;source.m2ts&quot;)
resized = core.resize.Bilinear(src, width=1280, height=720)

light_denoise = some_denoise_filter(resized)
heavy_denoise = some_other_denoise_filter(resized)

denoised = ...

aa = antialiasing(denoised)

aa = ...

default_deband = deband(aa)
light_deband   = deband1(aa)
medium_deband  = deband2(aa)

debanded = ...
</code></pre>
<h2><a class="header" href="#adding-the-frame-ranges" id="adding-the-frame-ranges">Adding the frame ranges</a></h2>
<p>Once you’ve done all of that, you’re done with filtering your source—at
least for the most part. Now all you need to do is add
<code>ReplaceFramesSimple</code> calls. For this, you need either the
plugin <a href="https://github.com/Irrational-Encoding-Wizardry/Vapoursynth-RemapFrames/releases">RemapFrames</a> or
the native Python version in
<a href="https://github.com/Irrational-Encoding-Wizardry/fvsfunc/blob/master/fvsfunc.py">fvsfunc</a><sup class="footnote-reference"><a href="#1">1</a></sup>.
<code>Rfs</code> is a shorthand for <code>ReplaceFramesSimple</code>
and fvsfunc has the alias <code>rfs</code>.</p>
<pre><code class="language-py">import vapoursynth as vs
core = vs.core

src = core.lsmas.LWLibavSource(&quot;source.m2ts&quot;)
resized = core.resize.Bilinear(src, width=1280, height=720)

### Denoising
light_denoise   = some_denoise_filter(resized)
heavy_denoise   = some_other_denoise_filter(resized)
heavier_denoise = some_stronger_denoise_filter(resized)

denoised = core.remap.Rfs(resized, light_denoise, mappings=&quot;&quot;)
denoised = core.remap.Rfs(denoised, heavy_denoise, mappings=&quot;&quot;)
denoised = core.remap.Rfs(denoised, heavier_denoise, mappings=&quot;&quot;)

### Anti-aliasing
eedi2_aa  = eedi2_aa_filter(denoised)
nnedi3_aa = nnedi3_aa_filter(denoised)

aa = core.remap.Rfs(denoised, eedi2_aa, mappings=&quot;&quot;)
aa = core.remap.Rfs(aa, nnedi3_aa, mappings=&quot;&quot;)

### Debanding
default_deband = default_deband(aa)
light_deband   = deband1(aa)
medium_deband  = deband2(aa)

debanded = default_deband  # will apply filter to the entire clip
debanded = core.remap.Rfs(debanded, light_deband, mappings=&quot;&quot;)
debanded = core.remap.Rfs(debanded, med_deband, mappings=&quot;&quot;)
</code></pre>
<p>So you created all your base filters and added Rfs calls. Now what? You
still have to perform the most tedious part of this entire
process—adding frame ranges to those calls. The basic workflow is
quite simple:</p>
<ol>
<li>
<p>Go to the start of the scene. View the next 2-3 frames. Go to the
end of the scene. View the previous 2-3 frames. Based on this,
decide on your filtering for the particular scene. If still in
doubt, look at other frames in the scene. Sometimes, you will find
that different frames in the same scene require different filtering,
but this is quite uncommon.</p>
</li>
<li>
<p>Now that you know what filter to use, simply add the frame range to
the respective Rfs call. To add a frame range to Rfs, you need to
enter it as a string in the <code>mappings</code> parameter. The format for the
string is <code>[start_frame end_frame]</code>. If you only want to add a
single frame, the format is <code>frame_number</code>. An example should help
you understand
better:</p>
<pre><code class="language-py"># The following replaces frames 30 to 40 (inclusive) and frame 50
# of the base clip with the filtered clip.
filtered = core.remap.Rfs(base, filtered, mappings=&quot;[30 40] 50&quot;)
</code></pre>
</li>
<li>
<p>Repeat with the next scene.</p>
</li>
</ol>
<p>When scenefiltering, it is good practice to comment out Rfs calls you’re
currently not using because they just make your script slower and eat up
memory.</p>
<p>This step can take anywhere from a few minutes to hours, depending on
the encoder and the source. Most of the time, the same filters can be
reused every episode with some minor changes here and there.</p>
<p>Now you might ask, “Why did I have to create base filters for
everything?” The answer is that these base filters allow other filters
to be added on top of them. Let’s say a scene requires <code>light_denoise</code>
but also needs <code>medium_deband</code> on top of that. Just put the same frame
ranges in their Rfs calls and watch it happen. What if a scene requires
denoising stronger than <code>heavier_denoise</code> ? Simple. Add another denoising
filter instead of <code>heavier_denoise</code> like so:</p>
<pre><code class="language-py">super_heavy_denoise = ultra_mega_super_heavy_denoise(filtered)

filtered = core.remap.Rfs(filtered, super_heavy_denoise, mappings=&quot;[x y]&quot;)
</code></pre>
<p>Using different denoisers on that same frame range is also possible, but
always consider the impacts on performance. Calling a strong, slow
denoise filter might still be faster (and better-looking) than calling a
weak, faster filter multiple times.</p>
<h3><a class="header" href="#editor-shortcuts--tips" id="editor-shortcuts--tips">Editor shortcuts / tips</a></h3>
<p>If using VSEdit as your <a href="preparation.html#the-editor">editor</a>,
it can be helpful to use the
built-in bookmark functionality
to find the frame ranges of each scene.
There is a <a href="https://gist.github.com/OrangeChannel/b9666b3650a3448589069d25dd6a394c">small script</a> that can generate
these bookmarks from your clip inside of VSEdit.
If you already have a keyframe file
(WWXD qp-file or Xvid keyframes)
you can instead use the <code>convert</code> function.</p>
<pre><code class="language-py"># Editing a script called 'example01.vpy'
import ...
from vsbookmark import generate

generate(clip, 'example01')
#convert('keyframes.txt', 'example01')
clip.set_output()
</code></pre>
<p>When previewing your clip,
there will now be bookmarks generated on the timeline
allowing you to skip to the next scene using the GUI buttons.</p>
<hr />
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>The python script may be slower than the plug-in due to the way it calls std.Splice to combine multiple re-mappings. The plug-in on the other hand, directly serves the frames of the second clip, with no calls to Splice. The speed difference will likely only be noticeable with a large amount of re-mappings. So, for the average script, it should be unnoticeable.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../encoding/video-artifacts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../encoding/masking-limiting-etc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../encoding/video-artifacts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../encoding/masking-limiting-etc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
